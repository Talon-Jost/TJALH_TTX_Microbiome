	 	 	 	
#Fastqc on files to trim based on quality score at 20 min quality. this was done through CLI with a dedicated file.
#this will loop through all of the fastq.gz files and run the trimmomatic on them with the trim.jar file located in that particular directory.
#multiqc can be used to check and visualize the outputs.
#!/bin/bash
for i in *fastq.gz; do 	
	filename=$(basename "$i" .fastq); 	java -jar trimmomatic-0.39.jar SE -threads 10 -phred33 $i trimmed_${filename}.fastq.gz ILLUMINACLIP:TruSeq3-SE:2:30:10 LEADING:20 TRAILING:20 SLIDINGWINDOW:5:20 MINLEN:90;
done

#importing the sequences that have been run through trimmomatic into the qiime environment using a pre-made manifest

qiime tools import
--type 'SampleData[SequencesWithQuality]'
--input-path manifest.tsv
--output-path tgranulosa_manifest
--input-format SingleEndFastqManifestPhred33V2

#just checking to make sure the sequences themselves will pass the quality filtering score again

qiime quality-filter q-score
--i-demux manifest/tgranulosa_manifest.qza
--p-min-quality 20
--output-dir quality_filtered
--o-filtered-sequences fastq_filtered_sequences
--o-filter-stats stats_fastq_filtered



qiime deblur denoise-16S
--i-demultiplexed-seqs quality_filtered/fastq_filtered_sequences.qza
--p-trim-length 250
--p-sample-stats
--p-min-reads 20
--p-min-size 10
--p-jobs-to-start 10
--output-dir deblur
--o-table table_deblur
--o-representative-sequences repseqs_deblur
--o-stats stats.deblur
--verbose



qiime feature-classifier classify-sklearn
--i-classifier TBJ_silva_138_min0max0.qza
--p-n-jobs 10
--i-reads deblur/repseqs_deblur.qza
--output-dir taxonomy/assigned_taxonomy.sequences



filtering
qiime taxa filter-table
--i-table taxonomy/table_mitochlorounass_rmvd.qza
--i-taxonomy taxonomy/classification.qza
--p-exclude Mitochondria,Chloroplast,Unassigned,Archaea,Corynebacterium
--o-filtered-table taxonomy/all_rmvd_archcorny


qiime taxa filter-seqs
--i-sequences taxonomy/seqs_mitochlorounass_rmvd.qza
--i-taxonomy taxonomy/classification.qza
--p-exclude Archaea,Cornybacterium
--o-filtered-sequences taxonomy/sequences_all_rmvd



qiime feature-table filter-samples
--i-table taxonomy/all_rmvd_archcorny.qza
--m-metadata-file newt_metadata.tsv
--p-where '[#SampleID]NOT IN("Pos")AND[#SampleID]NOT IN("Neg")'
--o-filtered-table taxonomy/no_posneg_all_rmvd



qiime feature-table filter-samples
--i-table taxonomy/table_mitochlorounass_rmvd.qza
--m-metadata-file newt_metadata.tsv
--p-where '[#SampleID]="Pos" OR [#SampleID]="Neg"'
--o-filtered-table decontam/pos_neg_table



Decontam
qiime quality-control decontam-score-viz
--i-decontam-scores decontam/new_decontam_scores.qza
--i-table taxonomy/no_posneg_all_rmvd.qza
--p-threshold 0.1
--p-weighted
--o-visualization decontam/weighted_vis.1



qiime quality-control decontam-remove
--i-decontam-scores decontam/new_decontam_scores.qza
--i-table taxonomy/all_rmvd_archcorny.qza
--p-threshold 0.1
--o-filtered-table decontam/table_contam_rmvd_0.1



Sub-sets
Bd Positive sites
qiime feature-table filter-samples 
--i-table decontam/table_contam_rmvd_0.1.qza 
--p-where '[Site]NOT IN("LSSP")AND[SITE]NOT IN("SLNF")' 
--m-metadata-file newt_metadata.tsv 
--o-filtered-table core_metrics/bd_present_sites/bd_present_sites_table


Bd positive samples
qiime feature-table filter-samples 
--i-table decontam/table_contam_rmvd_0.1.qza 
--p-where '[Bd_Presence]="1"' 
--m-metadata-file newt_metadata.tsv 
--o-filtered-table core_metrics/bd_positive_samples/bd_present_samples_table



Sequence Alignment
qiime phylogeny align-to-tree-mafft-iqtree
--i-sequences taxonomy/sequences_all_rmvd.qza
--o-alignment iqtree/aligned_sequences.iqtree
--o-masked-alignment iqtree/masked_aligment.iqtree
--o-tree iqtree/unrooted_tree
--o-rooted-tree iqtree/rooted_tree



Alpha Rarefaction
qiime diversity alpha-rarefaction
--i-table decontam/table_contam_rmvd_0.1.qza
--i-phylogeny iqtree/rooted_tree.qza
--m-metadata-file newt_metadata.tsv
--p-metrics 'simpson_e'
--p-metrics 'shannon'
--p-metrics 'simpson'
--p-metrics 'pielou_e'
--p-metrics 'observed_features'
--p-max-depth 2200
--p-steps 10
--o-visualization rarefaction/2200_rarefaction



Core metrics
All-samples
qiime diversity core-metrics-phylogenetic
--i-table decontam/table_contam_rmvd_0.1.qza
--i-phylogeny iqtree/rooted_tree.qza
--m-metadata-file newt_metadata.tsv
--p-sampling-depth 2200
--output-dir core_metrics/all_samples/2200

